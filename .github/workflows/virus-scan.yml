name: VirusTotal Scan

on:
  workflow_call:
    inputs:
      artifact_pattern:
        description: 'Pattern to match artifacts to download'
        required: false
        type: string
        default: 'GoTune-*'
    outputs:
      scan_results:
        description: 'Markdown table of scan results'
        value: ${{ jobs.scan.outputs.results }}
    secrets:
      VT_API_KEY:
        required: true

jobs:
  scan:
    name: Scan Packages
    runs-on: ubuntu-latest
    outputs:
      results: ${{ steps.format.outputs.table }}
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: ${{ inputs.artifact_pattern }}
          path: packages

      - name: Flatten directory structure
        run: |
          mkdir -p scan-files
          find packages -type f \( -name "*.zip" -o -name "*.tar.xz" -o -name "gotune-*" \) -exec cp {} scan-files/ \;
          echo "Files to scan:"
          ls -la scan-files/

      - name: Scan with VirusTotal
        id: virustotal
        uses: crazy-max/ghaction-virustotal@v4
        with:
          vt_api_key: ${{ secrets.VT_API_KEY }}
          request_rate: 4
          files: |
            scan-files/*.zip
            scan-files/*.tar.xz
            scan-files/gotune-*

      - name: Format scan results
        id: format
        run: |
          echo "Raw VirusTotal output:"
          echo "${{ steps.virustotal.outputs.analysis }}"

          # Parse the analysis output and create markdown table
          TABLE="| File | VirusTotal Analysis |
          |------|---------------------|"

          # Convert comma-separated to newline-separated, then parse
          # Use process substitution to avoid subshell issue with pipe
          while IFS= read -r line; do
            if [ -n "$line" ]; then
              # Extract filename (first part before =)
              FILE=$(echo "$line" | sed 's/=.*//' | xargs basename)
              # Extract URL (everything after first =)
              URL=$(echo "$line" | sed 's/^[^=]*=//')
              if [ -n "$FILE" ] && [ -n "$URL" ]; then
                TABLE="$TABLE
          | $FILE | [View Analysis]($URL) |"
              fi
            fi
          done < <(echo "${{ steps.virustotal.outputs.analysis }}" | tr ',' '\n')

          # Output as multiline string
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "table<<$EOF" >> $GITHUB_OUTPUT
          echo "$TABLE" >> $GITHUB_OUTPUT
          echo "$EOF" >> $GITHUB_OUTPUT
